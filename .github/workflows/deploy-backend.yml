name: Deploy Backend

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v4

    - name: Deploy to Fly.io
      uses: superfly/flyctl-actions/setup-flyctl@master

    - name: Deploy
      working-directory: ./backend
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      run: flyctl deploy --remote-only
      continue-on-error: true

    - name: Deploy to Railway (fallback)
      if: failure()
      run: |
        echo "Fly.io deployment failed. Please deploy manually or configure Railway."
        exit 0
